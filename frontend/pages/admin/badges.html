<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Badge Management | Niners.uz</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../styles/main.css">
</head>

<body>
    <div class="dashboard-grid">
        <div id="sidebarContainer"></div>
        <main class="main-content">
            <header style="margin-bottom: 30px;">
                <h2>Badge Management</h2>
                <p style="color: var(--text-muted);">Configure achievements and badges for the system.</p>
            </header>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px;">
                <!-- Add Badge Form -->
                <div class="card"
                    style="background: white; padding: 24px; border-radius: var(--radius-lg); box-shadow: var(--shadow-soft); height: fit-content;">
                    <h3 style="margin-bottom: 20px;">Add New Badge</h3>
                    <form id="addBadgeForm">
                        <div class="form-group">
                            <label>Name</label>
                            <input type="text" id="badgeName" class="form-control" placeholder="e.g., Bookworm"
                                required>
                        </div>
                        <div class="form-group">
                            <label>Icon (Emoji)</label>
                            <input type="text" id="badgeIcon" class="form-control" placeholder="e.g., üìö" required>
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea id="badgeDesc" class="form-control" rows="2"
                                placeholder="Short description of the badge..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Requirement (Condition)</label>
                            <textarea id="badgeReq" class="form-control" rows="2"
                                placeholder="What must the student do to earn this?" required></textarea>
                            <small style="color: var(--text-muted);">This text will be visible to students.</small>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">Add Badge</button>
                    </form>
                </div>

                <!-- Badge List -->
                <div class="card"
                    style="background: white; padding: 24px; border-radius: var(--radius-lg); box-shadow: var(--shadow-soft);">
                    <h3 style="margin-bottom: 20px;">Existing Badges</h3>
                    <div id="badgeList"
                        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 16px;">
                        <p>Loading...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../../js/api.js"></script>
    <script src="../../js/translations.js"></script>
    <script src="../../js/sidebar-loader.js"></script>
    <script>
        async function loadBadges() {
            const container = document.getElementById('badgeList');
            try {
                const badges = await api.get('/admin/badges');
                if (badges.length === 0) {
                    container.innerHTML = '<p>No badges found.</p>';
                    return;
                }
                container.innerHTML = badges.map(b => `
                    <div style="border: 1px solid #EEE; padding: 16px; border-radius: 12px; position: relative; background: #fff;">
                        <div style="font-size: 2.5rem; margin-bottom: 10px;">${b.icon}</div>
                        <h4 style="margin: 0 0 5px 0;">${b.name}</h4>
                        <p style="font-size: 0.85rem; color: #666; margin: 0 0 8px 0;">${b.description || ''}</p>
                        <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; font-size: 0.8rem; border: 1px dashed #ccc;">
                            <strong>Condition:</strong> ${b.requirement_text || 'None'}
                        </div>
                        <button onclick="deleteBadge(${b.id})" style="position: absolute; top: 10px; right: 10px; border: none; background: none; color: #ff6b6b; cursor: pointer; font-size: 1.2rem;">üóëÔ∏è</button>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '<p>Error loading badges.</p>';
                console.error(e);
            }
        }

        async function createBadge(e) {
            e.preventDefault();
            const name = document.getElementById('badgeName').value;
            const icon = document.getElementById('badgeIcon').value;
            const description = document.getElementById('badgeDesc').value;
            const requirement_text = document.getElementById('badgeReq').value;

            try {
                await api.post('/admin/badges', { name, icon, description, requirement_text });
                alert("Badge added successfully! üèÜ");
                document.getElementById('addBadgeForm').reset();
                loadBadges();
            } catch (err) {
                alert("Error: " + err.message);
            }
        }

        async function deleteBadge(id) {
            if (!confirm("Are you sure you want to delete this badge?")) return;
            try {
                await api.delete(`/admin/badges/${id}`);
                loadBadges();
            } catch (e) {
                alert("Error deleting badge: " + e.message);
            }
        }

        document.getElementById('addBadgeForm').addEventListener('submit', createBadge);

        document.addEventListener('DOMContentLoaded', () => {
            LanguageModule.init();
            loadBadges();
        });
    </script>
</body>

</html>